# Report: M5——An ongoing Walmart Sales prediction competition from Kaggle

**Note: This Report is available in Yuque online notebook( **[**https://www.yuque.com/docs/share/6534c759-5055-4f77-a74d-b159e8968aa9?#**](https://www.yuque.com/docs/share/6534c759-5055-4f77-a74d-b159e8968aa9?#)** ). It  provides same content but better viewing.**
## Abstract
**The goal:** We have been challenged to **predict sales data** provided by the retail giant [Walmart](https://en.wikipedia.org/wiki/Walmart) **28 days** into the future.
**The data:** We are mainly working with a 13,683,901 rows × 13 cols data.
**The method:** With about 67 different features we generated by different levels, we use **lgbm, LSTM.**
**The result: **We are currently ranking 240/3685(Top 9%), which is in the bronze medal zone.


## Introduction
### Backgound
The Makridakis Open Forecasting Center (MOFC) at the University of Nicosia conducts cutting-edge forecasting research and provides business forecast training. It helps companies achieve accurate predictions, estimate the levels of uncertainty, avoiding costly mistakes.
The MOFC is well known for its Makridakis Competitions, the first of which held in the 1980s. According to forecasting researcher and practitioner [Rob Hyndman](https://robjhyndman.com/hyndsight/) the M-competitions “have had an enormous influence on the field of forecasting. They focused attention on what models produced good forecasts, rather than on the mathematical properties of those models”.


[https://pixabay.com/](https://pixabay.com/)
[https://www.pexels.com/zh-cn/](https://www.pexels.com/zh-cn/)
[http://www.unsplash.com](http://www.unsplash.com)
### Motivation
In the Machine Learning and Data Science course(PAST 1501), professor Mark introduced foundation machine learning inside about linear regression, SVM, Neural Network and so on. It gives us insight and passion to implement machine learning that we learned to solve a real-world problem.
Also, Business Intelligence is an interesting topic that we want to devote to in future study and career. So we decided to attend this competition and expect to come up with a common model to forecast sales that can be applied in various business areas, such as setting up appropriate inventory or service levels. 


## Procedures and Method
### Data Description
The sales information in 3 .csv files following reaches back from Jan 2011 to June 2016, The sales information in 3 .csv files following reaches back from Jan 2011 to June 2016, as well as prices and events calendar provided additionally.
The validation set is provided but the evaluation set is unknown (teams will be ranked based on RMSE scores in predicting evaluation set.)
![image.png](https://cdn.nlark.com/yuque/0/2020/png/1301375/1589442024077-629edf28-e193-43a9-a015-54f4cf5e2af2.png#align=left&display=inline&height=281&margin=%5Bobject%20Object%5D&name=image.png&originHeight=600&originWidth=1082&size=73314&status=done&style=none&width=507)
Given that the dataset is  obtained from the competition, we  briefly present the origin files firstly downloaded.

 
1.[sales_train_validation.csv](https://www.yuque.com/attachments/yuque/0/2020/csv/1301375/1589457264856-486d953e-d047-4e63-b1d7-2cb507c6596c.csv?_lake_card=%7B%22uid%22%3A%221589416747457-0%22%2C%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Fcsv%2F1301375%2F1589457264856-486d953e-d047-4e63-b1d7-2cb507c6596c.csv%22%2C%22name%22%3A%22sales_train_validation.csv%22%2C%22size%22%3A120007726%2C%22type%22%3A%22text%2Fcsv%22%2C%22ext%22%3A%22csv%22%2C%22progress%22%3A%7B%22percent%22%3A99%7D%2C%22status%22%3A%22done%22%2C%22percent%22%3A0%2C%22id%22%3A%22Sikm7%22%2C%22card%22%3A%22file%22%7D)
![image.png](https://cdn.nlark.com/yuque/0/2020/png/1301375/1589416254603-000c44de-62c2-4092-8ac9-2b6a7e19c746.png#align=left&display=inline&height=155&margin=%5Bobject%20Object%5D&name=image.png&originHeight=310&originWidth=2206&size=85159&status=done&style=none&width=1103)
 The main data were obtained in 10 Walmart stores from the 3 US states of California (CA), Texas (TX), and Wisconsin (WI).
> Note: the test set (28 days we are challenged to predict) is not included

- **“Hierarchical” information:**** **The data split comprises 3049 individual products from 3 categories and 7 departments, sold in 10 stores in 3 states, thus can be aggregated on 4 different levels: item level, department level, product category level, and state level(or combined levels).
- Time Series data: 42,840 hierarchical sales time series, 1 column for each of the 1941 days from 2011-01-29 and 2016-05-22.



2.[sell_prices.csv](https://www.yuque.com/attachments/yuque/0/2020/csv/1301375/1589457264991-88b50cae-66be-4571-8501-4ddb0c727cb8.csv?_lake_card=%7B%22uid%22%3A%221589417174191-0%22%2C%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Fcsv%2F1301375%2F1589457264991-88b50cae-66be-4571-8501-4ddb0c727cb8.csv%22%2C%22name%22%3A%22sell_prices.csv%22%2C%22size%22%3A203395785%2C%22type%22%3A%22text%2Fcsv%22%2C%22ext%22%3A%22csv%22%2C%22progress%22%3A%7B%22percent%22%3A99%7D%2C%22status%22%3A%22done%22%2C%22percent%22%3A0%2C%22id%22%3A%22c6MuY%22%2C%22refSrc%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Fcsv%2F1301375%2F1589457264991-88b50cae-66be-4571-8501-4ddb0c727cb8.csv%22%2C%22card%22%3A%22file%22%7D)
![image.png](https://cdn.nlark.com/yuque/0/2020/png/1301375/1589417683717-0b8636a5-4bbe-4c27-9fb5-ba786350f256.png#align=left&display=inline&height=131&margin=%5Bobject%20Object%5D&name=image.png&originHeight=340&originWidth=686&size=37853&status=done&style=none&width=264)

- Weekly average prices:  The store and item IDs together with the sales price of the item as a weekly average.
> Note: the test set (28 days we are challenged to predict) is  included in this csv



3.[calendar.csv](https://www.yuque.com/attachments/yuque/0/2020/csv/1301375/1589457265149-c770a8a6-491d-4aa5-ba80-f3c7357be1bc.csv?_lake_card=%7B%22uid%22%3A%221589417260172-0%22%2C%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Fcsv%2F1301375%2F1589457265149-c770a8a6-491d-4aa5-ba80-f3c7357be1bc.csv%22%2C%22name%22%3A%22calendar.csv%22%2C%22size%22%3A103469%2C%22type%22%3A%22text%2Fcsv%22%2C%22ext%22%3A%22csv%22%2C%22progress%22%3A%7B%22percent%22%3A99%7D%2C%22status%22%3A%22done%22%2C%22percent%22%3A0%2C%22id%22%3A%229MFP1%22%2C%22card%22%3A%22file%22%7D)
![image.png](https://cdn.nlark.com/yuque/0/2020/png/1301375/1589417889842-0263f271-b36a-43e3-92a6-df97456eb40f.png#align=left&display=inline&height=304&margin=%5Bobject%20Object%5D&name=image.png&originHeight=608&originWidth=1986&size=118303&status=done&style=none&width=993)
Dates together with related features like day-of-the week, month, year, and special holidays

- Event days: Religious, sports or cultural event days like SuperBowl.
- SNAP days:  whether the stores in each state allowed purchases with [SNAP food stamps](https://www.benefits.gov/benefit/361).





### Exploratory Data Analysis
We draw many plots to find the patterns of data. The following 3 mindmaps are all conclusions we found in above-mentioned 3 files. To keep this report brief, we will only cover ground overview in this parts. And the next "Feature Engineering" parts we present the EDA directly related to each topics.
> Open this report in [https://www.yuque.com/docs/share/6534c759-5055-4f77-a74d-b159e8968aa9?#](https://www.yuque.com/docs/share/6534c759-5055-4f77-a74d-b159e8968aa9?#) will provide zooming.

#### Mindmaps of all findings
![](https://cdn.nlark.com/yuque/0/2020/png/1301375/1602431031380-50246930-33e0-4596-aebb-95c599373379.png)

![](https://cdn.nlark.com/yuque/0/2020/png/1301375/1602431030448-43d67cfb-9d2b-49bd-b40e-f5e8c5ddbe23.png)

![](https://cdn.nlark.com/yuque/0/2020/png/1301375/1602431030442-1699fde0-77d6-4b83-8f90-38a5d1955471.png)#### Time Series Pattern Overview (by only main sale_train csv.)

- **All aggregate sales:**
> Download interactive chart: [EDA-TS-1.html](https://www.yuque.com/attachments/yuque/0/2020/html/1301375/1589457265294-ffeadb8e-4422-44ef-b477-763f92af5244.html?_lake_card=%7B%22uid%22%3A%221589425852490-0%22%2C%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Fhtml%2F1301375%2F1589457265294-ffeadb8e-4422-44ef-b477-763f92af5244.html%22%2C%22name%22%3A%22EDA-TS-1.html%22%2C%22size%22%3A4815618%2C%22type%22%3A%22text%2Fhtml%22%2C%22ext%22%3A%22html%22%2C%22progress%22%3A%7B%22percent%22%3A99%7D%2C%22status%22%3A%22done%22%2C%22percent%22%3A0%2C%22id%22%3A%22gq4Dt%22%2C%22card%22%3A%22file%22%7D)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1301375/1589425500839-05cec5d4-7f5d-4fce-87e9-d59bde3e6d57.png#align=left&display=inline&height=250&margin=%5Bobject%20Object%5D&name=image.png&originHeight=832&originWidth=1540&size=401778&status=done&style=none&width=463)

   - Sales are generally going up, the most recent sales(2015~2016) appear to grow a bit faster.
   - Some yearly seasonality and strong weekly seasonality.
   - A dip at Christmas, which [the day of the year](https://www.countryliving.com/shopping/a23899891/walmart-christmas-hours/)  the stores are closed.



#### Adding Information of Price and Special Date (by additional price and calendar csv. files)

- **Price:**

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1301375/1589432912400-707d8428-ed49-4c0f-97e5-fcf838da6951.png#align=left&display=inline&height=275&margin=%5Bobject%20Object%5D&name=image.png&originHeight=832&originWidth=1540&size=252160&status=done&style=none&width=509)

   - First of all, the distributions are almost identical between the 3 states. 
      - Only some minute differences in the “FOODS” category
   - Also, there are notable differences between the categories: FOODs are on average cheaper than HOUSEHOLD items. And HOBBIES items span a wider range of prices than the other two; even suggesting a second peak at lower prices.



- **Calendar:**
   - **Events effect on sales in different category:**

**![image.png](https://cdn.nlark.com/yuque/0/2020/png/1301375/1589433925333-7990e12a-5c12-42ef-bee3-5b6134df4bd1.png#align=left&display=inline&height=290&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1018&originWidth=1852&size=608306&status=done&style=none&width=528)**

      - For HOBBIES, normal days have slightly large sales(also larger above-average portion)
      - FOODS sales are notably higher during “Sporting” events.
      - In general, “National” and “Religious” events both lead to relative decline in sales volume. 
   - **Events effect on sales in different ****State:**

**![image.png](https://cdn.nlark.com/yuque/0/2020/png/1301375/1589435380025-4d0d3dd5-29d3-4e83-9633-666efd1fe824.png#align=left&display=inline&height=298&margin=%5Bobject%20Object%5D&name=image.png&originHeight=920&originWidth=1632&size=475581&status=done&style=none&width=528)**

      - Special events slightly outsell non-event days in TX before 2014.

      - For WI, “National” events have a strong negative impact on sales numbers.
      - In contrast, “Religious” events have the smallest, but still negative impact in WI.
      - “Sporting” events have a positive influence in each state.

   - **SNAP days effect on sales in different ****State:**

**![image.png](https://cdn.nlark.com/yuque/0/2020/png/1301375/1589434958998-84f1ed78-4bba-47e1-806e-9455798d8c29.png#align=left&display=inline&height=224&margin=%5Bobject%20Object%5D&name=image.png&originHeight=894&originWidth=2112&size=723709&status=done&style=none&width=528)**

      - The SNAP days have clearly higher sales in every state. 
      - The largest difference to non-SNAP days is present for WI

### Feature Engineering
We extract 3 kinds of  features added up 106 features in total:

- `Basic features:` directly from provided Calendar, Price and the product Release Date we calculated.
> It has been clearly demonstrated in the previous EDA parts, so we save some words here. But the next two parts will be explained further through more EDA.

- `Lag features:`
- `Level features:`



![](https://cdn.nlark.com/yuque/0/2020/png/1301375/1602431031270-52538a1d-3702-4cbd-af9b-d0677351d757.png)#### Basic Features


> Code and result: [Basic features.ipynb](https://www.yuque.com/attachments/yuque/0/2020/ipynb/1301375/1589457265672-5a7c932d-174c-466e-bd21-eae0287dabe0.ipynb?_lake_card=%7B%22uid%22%3A%221589436590743-0%22%2C%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Fipynb%2F1301375%2F1589457265672-5a7c932d-174c-466e-bd21-eae0287dabe0.ipynb%22%2C%22name%22%3A%22Basic+features.ipynb%22%2C%22size%22%3A24802%2C%22type%22%3A%22%22%2C%22ext%22%3A%22ipynb%22%2C%22progress%22%3A%7B%22percent%22%3A99%7D%2C%22status%22%3A%22done%22%2C%22percent%22%3A0%2C%22id%22%3A%22t8RKR%22%2C%22card%22%3A%22file%22%7D)

| **RangeIndex:** 13683901 entries: **Data columns: **34 |  |
| :---: | --- |
| 11111Column            Dtype    
 0   id                category
 1   item_id           category
 2   dept_id           category
 3   cat_id            category
 4   store_id          category
 5   state_id          category
 6   d                 int16   
 7   sales             float64 
 8   release           int16   
 9   sell_price        float16 
 10  price_max         float16 
 11  price_min         float16 
 12  price_std         float16 
 13  price_mean        float16 
 14  price_norm        float16 
 15  price_nunique     float16 
 16  item_nunique      int16   
 17  price_momentum    float16 
 18  price_momentum_m  float16 
 19  price_momentum_y  float16 
 20  event_name_1      category
 21  event_type_1      category
 22  event_name_2      category
 23  event_type_2      category
 24  snap_CA           category
 25  snap_TX           category
 26  snap_WI           category
 27  tm_d              int8    
 28  tm_w              int8    
 29  tm_m              int8    
 30  tm_y              int8    
 31  tm_wm             int8    
 32  tm_dw             int8    
 33  tm_w_end          int8 | Discription
ID of all information(key index)
ID of item
ID of department
ID of category
ID of store
ID of state
ID of days counted from 0 ~ 1913
Sales data
Weeks that the product start to precent
prices from 
max prices
min prices
standard error of prices
mean of prices
max/min normalizaiton of price
count the number of unique prices
count the items set in an unique price
% change of price compared to last week
% change of price compared to last month
% change of price compared to last year
name of event1
type of event1
name of event2
type of event2
SNAP day in CA state
SNAP day in TX state
SNAP day in WI state
timestamp of actual day
timestamp of actual week
timestamp of month
timestamp of year  
nst week of the month
nst day of the week  
whether is weekend |
| **Data types: **category(13), float16(10), float64(1), int16(3), int8(7)

**Memory usage: **731.3 MB |  |
| 



#### Lags **Feature**
> Code and result: [Lags features.ipynb](https://www.yuque.com/attachments/yuque/0/2020/ipynb/1301375/1589457265758-8706cde9-308a-4c99-b931-523d876aaf88.ipynb?_lake_card=%7B%22uid%22%3A%221589443082097-0%22%2C%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Fipynb%2F1301375%2F1589457265758-8706cde9-308a-4c99-b931-523d876aaf88.ipynb%22%2C%22name%22%3A%22Lags+features.ipynb%22%2C%22size%22%3A79446%2C%22type%22%3A%22%22%2C%22ext%22%3A%22ipynb%22%2C%22progress%22%3A%7B%22percent%22%3A99%7D%2C%22status%22%3A%22done%22%2C%22percent%22%3A0%2C%22id%22%3A%22ENjEE%22%2C%22refSrc%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Fipynb%2F1301375%2F1589457265758-8706cde9-308a-4c99-b931-523d876aaf88.ipynb%22%2C%22card%22%3A%22file%22%7D)

The lag features are mainly handling seasonality in the data:



| **RangeIndex:** 13683901 entries: **Data columns:40** |  |
| :---: | --- |
| 11111Columns                 Dtype   
 0   id                      category
 1   d                       int16   
 2   sales                   float64 
 3   sales_lag_28            float16 
 4   sales_lag_29            float16 
 5   sales_lag_30            float16 
 6   sales_lag_31            float16 
 7   sales_lag_32            float16 
 8   sales_lag_33            float16 
 9   sales_lag_34            float16 
 10  sales_lag_35            float16 
 11  sales_lag_36            float16 
 12  sales_lag_37            float16 
 13  sales_lag_38            float16 
 14  sales_lag_39            float16 
 15  sales_lag_40            float16 
 16  sales_lag_41            float16 
 17  sales_lag_42            float16 
 18  rolling_mean_7          float16 
 19  rolling_std_7           float16 
 20  rolling_mean_14         float16 
 21  rolling_std_14          float16 
 22  rolling_mean_30         float16 
 23  rolling_std_30          float16 
 24  rolling_mean_60         float16 
 25  rolling_std_60          float16 
 26  rolling_mean_180        float16 
 27  rolling_std_180         float16 
 28  rolling_mean_tmp_1_7    float16 
 29  rolling_mean_tmp_1_14   float16 
 30  rolling_mean_tmp_1_30   float16 
 31  rolling_mean_tmp_1_60   float16 
 32  rolling_mean_tmp_8_7    float16 
 33  rolling_mean_tmp_8_14   float16 
 34  rolling_mean_tmp_8_30   float16 
 35  rolling_mean_tmp_8_60   float16 
 36  rolling_mean_tmp_15_7   float16 
 37  rolling_mean_tmp_15_14  float16 
 38  rolling_mean_tmp_15_30  float16 
 39  rolling_mean_tmp_15_60  float16 | Descriptions
ID of a product in a specific store
ID of the date (0~1913)
Sales data of d
Sales 28 days ago of d 
Sales 29 days ago of d 
Sales 30 days ago of d 
Sales 31 days ago of d 
Sales 32 days ago of d 
Sales 33 days ago of d 
Sales 34 days ago of d 
Sales 35 days ago of d 
Sales 36 days ago of d 
Sales 37 days ago of d 
Sales 38 days ago of d 
Sales 39 days ago of d 
Sales 40 days ago of d 
Sales 41 days ago of d 
Sales 42 days ago of d 
Average sales in past week
Standard error of sales in past week
Average sales in past 2 weeks
Standard error of sales in past 2 weeks
Average sales in past month
Standard error of sales in past month
Average sales in past 2 months
Standard error of sales in past 2 months
Average sales in past half year
Standard error of sales in past half year
Averages 7 days sales ended 1 days ago
Averages 14 days sales ended 1 days ago
Averages 30 days sales ended 1 days ago
Averages 60 days sales ended 1 days ago
Averages 7 days sales ended 8 days ago
Averages 14 days sales ended 8 days ago
Averages 30 days sales ended 8 days ago
Averages 60 days sales ended 8 days ago
Averages 7 days sales ended 15 days ago
Averages 14 days sales ended 15 days ago 
Averages 30 days sales ended 15 days ago
Averages 60 days sales ended 15 days ago |
| **Data types: **category(1), float16(37), float64(1), int16(1)
**Memory usage: 1.1 GB**
 |  |
| 



#### Combined Features
> Code and Result:[Levels features.ipynb](https://www.yuque.com/attachments/yuque/0/2020/ipynb/1301375/1589457265824-149768b2-4241-4941-a2d2-46bf07c8f999.ipynb?_lake_card=%7B%22uid%22%3A%221589450819619-0%22%2C%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Fipynb%2F1301375%2F1589457265824-149768b2-4241-4941-a2d2-46bf07c8f999.ipynb%22%2C%22name%22%3A%22Levels+features.ipynb%22%2C%22size%22%3A30956%2C%22type%22%3A%22%22%2C%22ext%22%3A%22ipynb%22%2C%22progress%22%3A%7B%22percent%22%3A99%7D%2C%22status%22%3A%22done%22%2C%22percent%22%3A0%2C%22id%22%3A%22QoGTE%22%2C%22card%22%3A%22file%22%7D)

| **RangeIndex:** 13683901 entries: **Data columns: 24** |  |
| :---: | --- |
| 10   id                         category
 1   d                          int16   
 2   enc_state_id_mean          float16 
 3   enc_state_id_std           float16 
 4   enc_store_id_mean          float16 
 5   enc_store_id_std           float16 
 6   enc_cat_id_mean            float16 
 7   enc_cat_id_std             float16 
 8   enc_dept_id_mean           float16 
 9   enc_dept_id_std            float16 
 10  enc_state_id_cat_id_mean   float16 
 11  enc_state_id_cat_id_std    float16 
 12  enc_state_id_dept_id_mean  float16 
 13  enc_state_id_dept_id_std   float16 
 14  enc_store_id_cat_id_mean   float16 
 15  enc_store_id_cat_id_std    float16 
 16  enc_store_id_dept_id_mean  float16 
 17  enc_store_id_dept_id_std   float16 
 18  enc_item_id_mean           float16 
 19  enc_item_id_std            float16 
 20  enc_item_id_state_id_mean  float16 
 21  enc_item_id_state_id_std   float16 
 22  enc_item_id_store_id_mean  float16 
 23  enc_item_id_store_id_std   float16 | ID of a product in a specific store
ID of the date (0~1913)10
average sales per state
sales standard error per state
average sales per store
sales standard error per store
average sales per category
sales standard error per store
average sales per department
sales standard error per department
average sales per state&category
sales standard error per state&category
average sales per state&department
sales standard error per state&department 
average sales per store&category
sales standard error per store&category
average sales per store&department
sales standard error per store&department
average sales per unit item
sales standard error per unit item
average sales per item&state
sales standard error per item&state
average sales per item&store
sales standard error per item&store
 |
| **Data types: **category(1), float16(37), float64(1), int16(1)
**Memory usage: 1.1 GB** |  |
| 

- ** Sales per State**(Explain Features 2~3)**:**
> Download interactive chart:[EDA-TS-2.html](https://www.yuque.com/attachments/yuque/0/2020/html/1301375/1589457265913-17cb37bb-be31-4a86-a250-9d28ac156725.html?_lake_card=%7B%22uid%22%3A%221589426278334-0%22%2C%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Fhtml%2F1301375%2F1589457265913-17cb37bb-be31-4a86-a250-9d28ac156725.html%22%2C%22name%22%3A%22EDA-TS-2.html%22%2C%22size%22%3A4703440%2C%22type%22%3A%22text%2Fhtml%22%2C%22ext%22%3A%22html%22%2C%22progress%22%3A%7B%22percent%22%3A99%7D%2C%22status%22%3A%22done%22%2C%22percent%22%3A0%2C%22id%22%3A%22qYsxS%22%2C%22refSrc%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Fhtml%2F1301375%2F1589457265913-17cb37bb-be31-4a86-a250-9d28ac156725.html%22%2C%22card%22%3A%22file%22%7D) 

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1301375/1589426131961-5866acbb-53b3-41b4-ad33-63df7817f975.png#align=left&display=inline&height=250&margin=%5Bobject%20Object%5D&name=image.png&originHeight=832&originWidth=1540&size=262729&status=done&style=none&width=463)

   - California (CA) sells more items in general(maybe because it contains 3 stores in data)
   - Wisconsin (WI) was slowly catching up to Texas (TX) and eventually surpassed in the last months.
- **Sales per stores**(Explain Features 4~5)**:**

**![image.png](https://cdn.nlark.com/yuque/0/2020/png/1301375/1589429484299-75ebadaa-f7ad-47a1-8850-0893de7317ab.png#align=left&display=inline&height=250&margin=%5Bobject%20Object%5D&name=image.png&originHeight=826&originWidth=1534&size=182506&status=done&style=none&width=464)

   - The CA stores are relatively well separated in store volume. 
      - “CA_2”, which declines to the “CA_4” level in 2015, recover and jump up to “CA_1” sales later.
   - TX stores are quite close together in sales
   - The WI stores “WI_1” and “WI_2” show a curious jump in 2012, while “WI_3” shows a long dip.
- **Sales per Category**(Explain Features 6~7)**:**

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1301375/1589428660440-b5a1c01c-e8be-4283-8690-925103861597.png#align=left&display=inline&height=250&margin=%5Bobject%20Object%5D&name=image.png&originHeight=832&originWidth=1540&size=267917&status=done&style=none&width=463)

   - “Foods” are the most common category in terms of sales, followed by “Household” which is still quite a bit above “Hobbies”.
   - However, the number of “Household” rows is closer to the number of “Foods” rows than the corresponding sales figures, indicating that more “Foods” units are sold than “Household” ones.
- **Sales per department and state**(Explain Features 12~13 as an example)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/1301375/1589445331729-09b0d73e-482c-427d-8ca6-f2c2347ae521.png#align=left&display=inline&height=269&margin=%5Bobject%20Object%5D&name=image.png&originHeight=920&originWidth=1632&size=137327&status=done&style=none&width=478)

   - “FOODS_3” is clearly driving the majority of “FOODS” category sales.

   - “HOUSEHOLD_1” is also outselling “HOUSEHOLD_2”.
   - “HOBBIES_1” has higher  sales  than “HOBBIES_2”, but both are not growing over time.

### Feature Selection
Clearly, computing power and memory don't allow us to feed all 110 columns into the model. Also, some of the features might cancel each other or just noise although some patterns showed in EDA. So before we fit the model, we need to select the features. There are 2 methods we have tried.
#### Permutation importance Test 
Feature importance can be measured by looking at how much the score decreases when a feature is not available.
To do that one can remove feature from the dataset, re-train the estimator and check the score. Because estimators expect feature to be present. So instead of removing a feature we can **replace it with random noise** - feature column is still there, but it no longer contains useful information. The simplest way to get such noise is to shuffle values for a feature, i.e. use other examples’ feature values - this is how permutation importance is computed.
It's not good when feature replaced by shuffled noise but we have better score(less RMSE).
 
![image.png](https://cdn.nlark.com/yuque/0/2020/png/1301375/1589447430825-13049e8c-6567-4893-a81b-ed13993e17a3.png#align=left&display=inline&height=250&margin=%5Bobject%20Object%5D&name=image.png&originHeight=692&originWidth=1306&size=186934&status=done&style=none&width=472)

- For example, the features (day of the week) is clearly an important feature, given that after the features removed, the RMSE of the model increase by about 0.1 (Base RMSE is 2.04242).
#### Features selected
We removed 31 features out of 106 features listed previously, then get 75 features trained for the model.
**
### Model Fitting
> Code and results: [main.ipynb](https://www.yuque.com/attachments/yuque/0/2020/ipynb/1301375/1589457266247-7f99df7f-3edc-4300-a928-89483b26fce5.ipynb?_lake_card=%7B%22uid%22%3A%221589450876400-0%22%2C%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Fipynb%2F1301375%2F1589457266247-7f99df7f-3edc-4300-a928-89483b26fce5.ipynb%22%2C%22name%22%3A%22main.ipynb%22%2C%22size%22%3A41819%2C%22type%22%3A%22%22%2C%22ext%22%3A%22ipynb%22%2C%22progress%22%3A%7B%22percent%22%3A99%7D%2C%22status%22%3A%22done%22%2C%22percent%22%3A0%2C%22id%22%3A%22lyNl9%22%2C%22card%22%3A%22file%22%7D)

Model selecting
Gradient boosting is a sort of best of both worlds algorithm, in the sense that models are optimized via gradient descent on generic differentiable loss functions, but also reap the natural benefits of tree-based models like automatic null-handling, automatic feature selection and interaction, scale invariance, and ability to capture (highly) non-linear feature-target relationships. These characteristics make gradient boosted models very robust to messy and heterogenous data (e.g. nullness, outliers, mix of numerics on different scales and categoricals) and also highly expressive, and therefore applicable to a wide range of problems. It gets even better because of how flexible they are -- model complexity can be controlled on a very precise level by tuning a large set of structural (max tree depth, number of leaves) and regularization (learning rate, col/row subsampling, l1/l2 reg, …) parameters.


So in short, gradient boosting models are a pretty all-inclusive package for covering the wide range of complexity settings that can occur in real world datasets, especially heterogenous ones (neural networks are often better when working with homogenous data like images, text, or audio signals). The typical kaggle competition is unlikely to involve features that can be mapped to targets in a simple linear manner, since problems of that form would be much less challenging and interesting. Therefore, a generically powerful and flexible tool like gradient boosting becomes the model of choice in most tabular competitions, at least as a starting point.


Among the high-profile gradient boosting libraries (LGB, XGBoost, CatBoost), LGB seems to be both the fastest and most flexible (see things like built-in category handling, I'm not sure if XGB has this). In particular, LGB uses highly optimized histogram binning as a means of speeding up the tree-splitting process. Doing well in kaggle competitions tends to be driven by performing large numbers of diverse experiments (in the sense of feature sets, model hyperparameters, etc.), for which a fast, high-performing library like LGB is outstanding.
#### LGBM Model
Light GBM is a gradient boosting framework that uses tree based learning algorithm. Light GBM grows tree vertically while other algorithm grows trees horizontally meaning that Light GBM grows tree leaf-wise while other algorithm grows level-wise.
![image.png](https://cdn.nlark.com/yuque/0/2020/png/1301375/1589448578439-ee52df59-6bc5-4f8e-9eac-e2e409428d52.png#align=left&display=inline&height=177&margin=%5Bobject%20Object%5D&name=image.png&originHeight=444&originWidth=1358&size=264099&status=done&style=none&width=542)
In this problem, the data is provided vertically amplified (7 departments of 3 categories, 10 stores of 3 states...)
#### Parameter Setting

- `**'boosting_type': 'gbdt'**`
- `**'objective':**` 'tweedie' Tweedie Gradient Boosting for extremely unbalanced Zero-inflated Data like this problem
- **`'tweedie_variance_power'`**`:` default = 1.5, set this closer to 1 to shift towards a Poisson distribution, our CV searching shows 1.1 is optimal
-  **`'subsample': 0.5:`** to fight with overfit, this will randomly select part of data without resampling
- **`'learning_rate': 0.03`** Also Chosen by CV
- **`'num_leaves': 2**11-1`**
-  **`'min_data_in_leaf': 2**12-1`**
- **`'n_estimators': 1400`** avoid any early stoping that might overfit Public LB.
- **`'boost_from_average': False`** : to avoid some bugs for custom loss



## Result
After several features modification, we obtained 0.47474 error scores and are currently ranking NO.293 out of 3,797 teams.
> We are currently safe in the bronze medal zone (3800*10%=380 teams), but the ranks change every day so we need to keep it up.

偷图：[https://www.kaggle.com/omershect/learning-pytorch-lstm-deep-learning-with-m5-data/notebook#Main-Steps-](https://www.kaggle.com/omershect/learning-pytorch-lstm-deep-learning-with-m5-data/notebook#Main-Steps-)

模型比较[https://www.kaggle.com/tarunpaparaju/m5-competition-eda-models](https://www.kaggle.com/tarunpaparaju/m5-competition-eda-models)
![image.png](https://cdn.nlark.com/yuque/0/2020/png/1301375/1589449333453-a853bc74-c2b4-4ddd-82f4-49102f18995e.png#align=left&display=inline&height=300&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1212&originWidth=1920&size=241600&status=done&style=none&width=475)
## Additional
### **User Interface**
To make predictions convenient to other clients or users, we draw a user interface with pre-trained model. If the new data imported the website will calculated the predictions for Walmart sales manager.
![image.png](https://cdn.nlark.com/yuque/0/2020/png/1301375/1589450981939-3ac0622a-f167-482a-82c9-a326be14d6fd.png#align=left&display=inline&height=394&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1502&originWidth=2844&size=1712622&status=done&style=none&width=746)


### Further Improvements options
To obtained better scores, there are some methods we will tried in the futures:

- `**Recursively prediction:**`** **now we are forecasting per store but 28 days in one time. If we could like forecast 1-day-by-1-day and use the prediction to forecast the second day, some features like lag_1 could be included in this model. (The Importance Test shows that it's a key explain variable)
- `**K-fold CV**`: Due to limit of computing resources and memory, we replace the stable K-fold CV into simple CV. It still requires 12 hours to train the models. If we can find a proper online server, more accurate model can be found



## Reference


